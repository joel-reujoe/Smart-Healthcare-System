<html>
    <head>
        <title>Home</title>
        <!-- <link rel="stylesheet" type="text/css" href="style.css"> -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Compiled and minified JavaScript -->
        <script src="../js/image-compressor/dist/image-compressor.min.js"></script>
        <script src="../js/image-compressor/dist/image-compressor.js"></script>

        <link href="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.0.0/cropper.min.css" rel="stylesheet"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/cropper/4.0.0/cropper.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
        <style>
        .col.s12 > .btn {
                width: 100%;
            }
            i.icon-teal {
            color:teal;
        }
        </style>
    </head>
    <body class="body" id="body">
        <nav>
                <div class="nav-wrapper teal">
                        <a href="#" class="brand-logo center">DocCall</a> 
                
               
                    
                    <ul id="nav-mobile" class="left hide-on-med-and-down">
                      <li><a href="homepage.html"> HOME</a></li>
                      <li class="grey"><a href="report.html">Add Report</a></li>
                      <li><a href="appoinment.html">View Appointment</a></li>
                      <li><a href="Notification.html">Notifications</a></li>
                    </ul>
                </div>
            
                <ul id="slide-out" class="sidenav">
                <li><div class="user-view">
                        <div class="background">
                          <img src="images/img.jpg">
                        </div>
                        <a href="#user"><img class="circle" src="images/img-1.jpeg"></a>
                        <a href="#name"><span class="white-text name">John Doe</span></a>
                        <a href="#email"><span class="white-text email">jdandturk@gmail.com</span></a>
                      </div></li>
            <li><a href="#!">Something</a></li>
            <li><a href="#!">Something</a></li>
          </ul>
          
          <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>               
        </div>
        
        
        </nav>
           
        <div >
                <div class="container">
                        <table class="striped z-depth-3">
                                <thead>
                                  <tr>
                                      <th>Report ID</th>
                                      <th>Report Description</th>
                                      <th>Downloadable Link</th>
                                      <th>Issued By</th>
                                      <th>Date</th>
                                  </tr>
                                </thead>
                        
                                <tbody>
                                  <tr>
                                    <td>13848</td>
                                    <td>Piles</td>
                                    <td><a href="#"> 1do3chaar5che</a></td>
                                    <td>Asaram bapu</td>
                                    <td>30th feb</td>
                                  </tr>
                                  <tr>
                                    <td>6666</td>
                                    <td>BP</td>
                                    <td><a href="#"> petsafaa,har rog dafaa :)</a> </td>
                                    <td>Baba Ramdev</td>
                                    <td>31st feb</td>
                                  </tr>
                                  <tr>
                                    <td>69696969</td>
                                    <td>idk</td>
                                    <td><a href="#"> www.getyourreport.com </a></td>
                                    <td>Shanta bai</td>
                                    <td>31st june</td>
                                  </tr>
                                </tbody>
                              </table>
                    </div>
        </div>
        
        </body>
</html>
<script src="https://www.gstatic.com/firebasejs/5.5.0/firebase.js"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<!-- <script src="./js/functions/lib/general.js"></script>
<script src="./js/functions/lib/post/post.js"></script> -->
<script>
    
    document.addEventListener('DOMContentLoaded', function() {
    var elems = document.querySelectorAll('.sidenav');
    var instances = M.Sidenav.init(elems);
  });
var config = {
    apiKey: "AIzaSyB0ga6ikjDvGADhhd80r2Xeiaep3K22H-M",
    authDomain: "smarthealthcare-160f0.firebaseapp.com",
    databaseURL: "https://smarthealthcare-160f0.firebaseio.com",
    projectId: "smarthealthcare-160f0",
    storageBucket: "smarthealthcare-160f0.appspot.com",
    messagingSenderId: "488465131798"
  };



firebase.initializeApp(config);
var starCountRef = firebase.database().ref().child('post');
starCountRef.orderByChild("timestamp").on('child_added',snapshot=>{
if(snapshot.val().image)
{
    var div=document.createElement('div')
        div.innerHTML=`<div class="section" >
                <div class="container">
                    <div class="card" id=card${snapshot.key}>
                        <div class="card-content">
                            <div class="row">
                                <div class="col s6">
                                    <a href="#!" data-userid=${snapshot.val().poster_id}><strong>${snapshot.val().poster}</strong></a>                                    
                                </div>
                            </div>
                            <div class="row">
                                <div class="col s12">
                                 ${snapshot.val().postText}       
                                </div>
                            </div>
            
                            <div class="row">
                                <div class="col s12">
                                    <img src="${snapshot.val().imageUrl}" width="300" height="300">
                                </div>
                            </div>
                        </div>
                        <div class="card-action">
                            <button  class="btn-flat teal-text white likeClass" data-likekey=${snapshot.key}><i class="material-icons icon-white">thumb_up_alt</i>${snapshot.val().likes}</button>
                            <button  class="btn-flat teal-text white" id="${snapshot.key}" data-commentkey=${snapshot.key}><i class="material-icons icon-white">text_sms</i></button>
                        </div>
                        <div class="container" id="commentSection${snapshot.key}" style="display:none">
                            <div class="row">
                            <div class="input-field col s12">
                                <input type="text" class="commentBox" id="comment${snapshot.key}">
                                <label for="comment${snapshot.key}">Comment</label>
                            </div>
                            <div class="input-field col s12">
                                <button class="btn btn-flat teal white-text" id="commentbutton${snapshot.key}">Comment</button>
                            </div>    
                        </div>
                    </div>
                </div>
            </div>`
            document.getElementById("divPostContents").insertBefore(div,document.getElementById("divPostContents").firstChild)
    document.getElementById(snapshot.key).addEventListener("click",function(event){
        event.preventDefault();
        this.dataset.status=true
        if(this.dataset.status){
                this.dataset.status=false;
                document.getElementById("commentSection"+snapshot.key).style.display="block"
            }else{
                this.dataset.status=true;
                document.getElementById("commentSection"+snapshot.key).style.display="none"
            }
    })
    firebase.database().ref('post/'+snapshot.key+'/comments').on("value",function(snapshotChild){
        snapshotChild.forEach(function(childSnapshot){
            var div=document.createElement("div")
            div.innerHTML=`<div class="container">
                <div class="row">
                    <div class="col s12">
                        ${childSnapshot.val().commentBy}
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                        ${childSnapshot.val().commentText}
                    </div>
                </div>
            </div>`
            document.getElementById("commentSection"+snapshot.key).appendChild(div)            
        })
    })
    document.getElementById("commentbutton"+snapshot.key).addEventListener("click",function(event){
        var commentText=document.getElementById("comment"+snapshot.key).value;
        firebase.database().ref('post/'+snapshot.key+'/comments').push({
                commentBy:"2",
                commentText:commentText
        })  
    })
}
else{
    var div=document.createElement('div')
        div.innerHTML=`
            <div class="section">
                <div class="container">
                    <div class="card" id=card${snapshot.key}>
                        <div class="card-content">
                            <div class="row">
                                <div class="col s6">
                                    <a href="#!"><strong>${snapshot.val().poster}</strong></a>                                    
                                </div>
                            </div>
                            <div class="row">
                                <div class="col s12">
                                 ${snapshot.val().postText}       
                                </div>
                            </div>
                        </div>
                        <div class="card-action">
                            <button  class="btn-flat teal-text white likeClass" data-likekey=${snapshot.key}><i class="material-icons icon-white">thumb_up_alt</i>${snapshot.val().likes}</button>
                            <button  class="btn-flat teal-text white commentClass" id=${snapshot.key} data-commentkey=${snapshot.key}><i class="material-icons icon-white">text_sms</i></button>
                        </div>
                        <div class="container" id="commentSection${snapshot.key}" style="display:none">
                            <div class="row">
                            <div class="input-field col s12">
                                <input type="text" class="commentBox" id="comment${snapshot.key}">
                                <label for="comment${snapshot.key}">Comment</label>
                            </div>
                            <div class="input-field col s12">
                                <button class="btn btn-flat teal white-text" id="commentbutton${snapshot.key}">Comment</button>
                            </div>    
                        </div>
                    </div>
                    </div>
                </div>
            </div>`
            document.getElementById("divPostContents").insertBefore(div,document.getElementById("divPostContents").firstChild)
    
    document.getElementById(snapshot.key).addEventListener("click",function(event){
        event.preventDefault();
        this.dataset.status=true
        if(this.dataset.status){
            this.dataset.status=false                
                document.getElementById("commentSection"+snapshot.key).style.display="block"
            }else{
            this.dataset.status=true                
                document.getElementById("commentSection"+snapshot.key).style.display="none"
            }
    })
    firebase.database().ref('post/'+snapshot.key+'/comments').on("value",function(snapshotChild){
        var div=document.createElement("div")
        snapshotChild.forEach(function(childSnapshot){
            div.innerHTML=`<div class="container">
                <div class="row">
                    <div class="col s12">
                        ${childSnapshot.val().commentBy}
                    </div>
                </div>
                <div class="row">
                    <div class="col s12">
                        ${childSnapshot.val().commentText}
                    </div>
                </div>
            </div>`
            document.getElementById("commentSection"+snapshot.key).appendChild(div)
        })
    })
    document.getElementById("commentbutton"+snapshot.key).addEventListener("click",function(event){
        var commentText=document.getElementById("comment"+snapshot.key).value;
        firebase.database().ref('post/'+snapshot.key+'/comments').push({
                commentBy:"2",
                commentText:commentText
        })  
    })
}

var likeButton=document.getElementsByClassName("likeClass")

for(var i=0;i<likeButton.length;i++)
{
    likeButton[i].addEventListener("click",function(event){
        event.preventDefault()
        updateLike(this)
    })
}

var commentButton=document.getElementsByClassName("commentClass")
    
    
})

updateLike=function(elem)
{
    console.log(elem)
    var starCountRef = firebase.database().ref().child('post').child(elem.dataset.likekey)
        starCountRef.once("value",snapshot=>{
            if(elem.childNodes[0].getAttribute("class")=="material-icons icon-white")
            {
                var likeCount=snapshot.val().likes;
                likeCount=likeCount+1;
                elem.childNodes[1].nodeValue=likeCount
                elem.childNodes[0].setAttribute("class","material-icons icon-teal");
                firebase.database().ref('post/'+elem.dataset.likekey).update({
                    likes:likeCount
                })
                firebase.database().ref('post/'+elem.dataset.likekey+'/likedBy').push({
                    userId:"2"
                })
            }
            else{
                var likeCount=snapshot.val().likes;
                likeCount=likeCount-1;
                elem.childNodes[1].nodeValue=likeCount
                elem.childNodes[0].setAttribute("class","material-icons icon-white");
                firebase.database().ref('post/'+elem.dataset.likekey).update({
                    likes:likeCount
                })
                firebase.database().ref('post/'+elem.dataset.likekey+'/likedBy').orderByChild("userId").equalTo("2").once("value").then(function(snapshot){
                    snapshot.forEach(function(childSnapshot){
                        firebase.database().ref('post/'+elem.dataset.likekey+'/likedBy').child(childSnapshot.key).remove() 
                    })
                })
            }
        })
}

document.getElementById('btnPost').addEventListener('click', (e) => {

  const file = document.getElementById("txtFile").files[0];
  var postText=document.getElementById("txtareaPost").value;
    
if(postText!="")
{
  if(file)
  {
    var urlGlobal="";
    new ImageCompressor(file, {
        quality: .6,
        success(result) {
            console.log(result)
            storageRef = firebase.storage().ref("files/" + result.name);
            uploadTask = storageRef.put(result);
            uploadTask.on('state_changed', function(snapshot){
                var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                console.log('Upload is ' + progress + '% done');
        switch (snapshot.state) {
            case firebase.storage.TaskState.PAUSED: // or 'paused'
                console.log('Upload is paused');
                break;
            case firebase.storage.TaskState.RUNNING: // or 'running'
                console.log('Upload is running');
                break;
            }
        },
            function(error) {
            console.log(error)
            },  
            function() {
                uploadTask.snapshot.ref.getDownloadURL().then(function(downloadURL) {
                firebase.database().ref('post/').push({
                    poster_id:"1",
                    poster: "joel",
                    postText:postText,
                    image:true,
                    imageUrl:downloadURL,
                    likes:0,
                    timestamp:Date.now()
                });
                })
            })
        }, 
        error(e) {
        console.log(e.message);
        },
    });
    }
    else{
        firebase.database().ref('post/').push({
            poster_id:"1",
            poster: "joel",
            postText:postText,
            image:false,
            likes:0,
            timestamp:Date.now()
            });
    }
}
  
});



</script>
<script>
// $('document').ready(function()
// {
//     $('textarea').each(function(){
//             $(this).val($(this).val().trim());
//         }
//     );
// });
// document.getElementById("postButton").style.backgroundColor="grey"
// document.getElementById("postButton").disabled=true
// document.getElementById("postArea").addEventListener("change",function(event){
//     if(document.getElementById("postArea").value!="")
//     {
//         document.getElementById("postButton").disabled=false
//         document.getElementById("postButton").style.backgroundColor="#6666ff"
//     }
//     else{
//         document.getElementById("postButton").style.backgroundColor="grey"
//         document.getElementById("postButton").disabled=true
//     }
// })
// document.getElementById("postButton").addEventListener("click",function(event){
//     var param=getPost()
//     if(param!=null)
//     {
//         axios({
//             method:'post',
//             url:`${globalpath}controllers/ctrl-doctor`,
//             params:param
//         }).then(function(response){
//             console.log(response)
//         }).catch(function(error){
//             console.log(error)
//         })
//     }
// })
// </script>
<script>
// $(document).ready(function(){
//     $('[data-toggle="popover"]').popover({
//         html:true,
//         content:function(){
//             var content=$(this).attr("data-popover-content")
//             return $(content).children(".popover-content").html();
//         }
//     });
// })
// document.getElementById("ass").addEventListener("click",function(event){
//     event.preventDefault();
//     window.location="AP.html"
// })
// document.getElementById("sm").addEventListener("click",function(event){
//     event.preventDefault();
//     window.location="sm.html";
// })
// document.getElementById("gpr").addEventListener("click",function(event){
//     event.preventDefault();
//     window.location="gpr.html";
// })
// document.getElementById("postButton").addEventListener("click",function(event){
//     event.preventDefault();
    
// })
// document.getElementById("uploadimage").addEventListener("click",function(event){
//     event.preventDefault();
//     document.getElementById("imageFile").click();
// })

// function logout()
// {
//     window.location="login.html";
// }
</script>